generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Persona {
  id          String      @id @default(uuid())
  type        PersonaType @unique
  name        String
  description String
  permissions Json?
  preferences Json?
  metadata    Json?
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  users       User[]

  @@map("personas")
}

model User {
  id                String            @id @default(uuid())
  email             String            @unique
  passwordHash      String
  driverName        String
  teamName          String?
  isAdmin           Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  normalizedName    String?           @map("normalized_name")
  transponderNumber String?           @map("transponder_number")
  personaId         String?           @map("persona_id")
  isTeamManager     Boolean           @default(false) @map("is_team_manager")
  eventDriverLinks  EventDriverLink[]
  driverLinks       UserDriverLink[]
  persona           Persona?          @relation(fields: [personaId], references: [id])
  auditLogs         AuditLog[]
  carProfiles       CarProfile[]
  driverProfiles    DriverProfile[]
  trackMaps         TrackMap[]

  @@index([normalizedName])
  @@index([transponderNumber])
  @@index([personaId])
  @@index([isTeamManager, teamName], map: "users_is_team_manager_team_name_idx")
  @@map("users")
}

model CarProfile {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  carType     String   @map("car_type")
  vehicleType String   @map("vehicle_type")
  setupInfo   Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("car_profiles")
}

model DriverProfile {
  id                String   @id @default(uuid())
  userId            String   @map("user_id")
  name              String
  displayName       String   @map("display_name")
  transponderNumber String?  @map("transponder_number")
  preferences       Json?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("driver_profiles")
}

model Track {
  id                     String    @id @default(uuid())
  source                 String
  sourceTrackSlug        String    @map("source_track_slug")
  trackName              String    @map("track_name")
  trackUrl               String    @map("track_url")
  eventsUrl              String    @map("events_url")
  livercTrackLastUpdated String?   @map("liverc_track_last_updated")
  lastSeenAt             DateTime? @map("last_seen_at")
  isActive               Boolean   @default(true) @map("is_active")
  isFollowed             Boolean   @default(false) @map("is_followed")
  latitude               Float?
  longitude              Float?
  address                String?
  city                   String?
  state                  String?
  country                String?
  postalCode             String?   @map("postal_code")
  phone                  String?
  website                String?
  email                  String?
  description            String?
  logoUrl                String?   @map("logo_url")
  facebookUrl            String?   @map("facebook_url")
  totalLaps              Int?      @default(0) @map("total_laps")
  totalRaces             Int?      @default(0) @map("total_races")
  totalEvents            Int?      @default(0) @map("total_events")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  events                 Event[]
  trackMaps              TrackMap[]

  @@unique([source, sourceTrackSlug])
  @@index([source, sourceTrackSlug])
  @@index([isActive, isFollowed])
  @@map("tracks")
}

model Event {
  id                   String                @id @default(uuid())
  source               String
  sourceEventId        String                @map("source_event_id")
  trackId              String                @map("track_id")
  eventName            String                @map("event_name")
  eventDate            DateTime              @map("event_date")
  eventEntries         Int                   @map("event_entries")
  eventDrivers         Int                   @map("event_drivers")
  eventUrl             String                @map("event_url")
  ingestDepth          IngestDepth           @default(none) @map("ingest_depth")
  lastIngestedAt       DateTime?             @map("last_ingested_at")
  metadata             Json?                 @map("metadata")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  driverLinks          EventDriverLink[]
  entries              EventEntry[]
  track                Track                 @relation(fields: [trackId], references: [id], onDelete: Cascade)
  races                Race[]
  transponderOverrides TransponderOverride[]
  weatherData          WeatherData[]
  raceClasses          EventRaceClass[]

  @@unique([source, sourceEventId])
  @@index([source, sourceEventId])
  @@index([trackId])
  @@index([eventDate])
  @@index([trackId, eventDate])
  @@index([ingestDepth])
  @@map("events")
}

model EventEntry {
  id                String          @id @default(uuid())
  eventId           String          @map("event_id")
  driverId          String          @map("driver_id")
  className         String          @map("class_name")
  transponderNumber String?         @map("transponder_number")
  carNumber         String?         @map("car_number")
  eventRaceClassId  String?         @map("event_race_class_id")
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  driver            Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  event             Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  eventRaceClass    EventRaceClass? @relation(fields: [eventRaceClassId], references: [id], onDelete: SetNull)

  @@unique([eventId, driverId, className])
  @@index([eventId])
  @@index([driverId])
  @@index([className])
  @@index([eventRaceClassId])
  @@map("event_entries")
}

model EventRaceClass {
  id                       String       @id @default(uuid())
  eventId                  String       @map("event_id")
  className                 String       @map("class_name")
  vehicleType              String?      @map("vehicle_type")
  vehicleTypeNeedsReview   Boolean      @default(true) @map("vehicle_type_needs_review")
  vehicleTypeReviewedAt    DateTime?    @map("vehicle_type_reviewed_at")
  vehicleTypeReviewedBy    String?      @map("vehicle_type_reviewed_by")
  createdAt                DateTime     @default(now()) @map("created_at")
  updatedAt                DateTime     @updatedAt @map("updated_at")
  event                    Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  entries                  EventEntry[]

  @@unique([eventId, className])
  @@index([eventId])
  @@index([eventId, className])
  @@map("event_race_classes")
}

model Race {
  id                       String                @id @default(uuid())
  eventId                  String                @map("event_id")
  source                   String
  sourceRaceId             String                @map("source_race_id")
  className                String                @map("class_name")
  raceLabel                String                @map("race_label")
  raceOrder                Int?                  @map("race_order")
  raceUrl                  String                @map("race_url")
  startTime                DateTime?             @map("start_time")
  durationSeconds          Int?                  @map("duration_seconds")
  sessionType              SessionType?          @map("session_type")
  createdAt                DateTime              @default(now()) @map("created_at")
  updatedAt                DateTime              @updatedAt @map("updated_at")
  drivers                  RaceDriver[]
  results                  RaceResult[]
  event                    Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)
  transponderOverridesFrom TransponderOverride[]

  @@unique([eventId, sourceRaceId])
  @@index([eventId, sourceRaceId])
  @@index([eventId])
  @@index([raceOrder])
  @@index([sessionType])
  @@index([eventId, sessionType])
  @@map("races")
}

model Driver {
  id                   String                @id @default(uuid())
  source               String
  sourceDriverId       String                @map("source_driver_id")
  displayName          String                @map("display_name")
  normalizedName       String?               @map("normalized_name")
  createdAt            DateTime              @default(now()) @map("created_at")
  updatedAt            DateTime              @updatedAt @map("updated_at")
  transponderNumber    String?               @map("transponder_number")
  eventDriverLinks     EventDriverLink[]
  eventEntries         EventEntry[]
  raceDrivers          RaceDriver[]
  transponderOverrides TransponderOverride[]
  userDriverLink       UserDriverLink?

  @@unique([source, sourceDriverId])
  @@index([source, sourceDriverId])
  @@index([displayName])
  @@index([normalizedName])
  @@map("drivers")
}

model RaceDriver {
  id                String       @id @default(uuid())
  raceId            String       @map("race_id")
  source            String
  sourceDriverId    String       @map("source_driver_id")
  displayName       String       @map("display_name")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  driverId          String       @map("driver_id")
  transponderNumber String?      @map("transponder_number")
  driver            Driver       @relation(fields: [driverId], references: [id])
  race              Race         @relation(fields: [raceId], references: [id], onDelete: Cascade)
  results           RaceResult[]

  @@unique([raceId, sourceDriverId])
  @@index([raceId, sourceDriverId])
  @@index([raceId])
  @@index([driverId])
  @@map("race_drivers")
}

model RaceResult {
  id                   String     @id @default(uuid())
  raceId               String     @map("race_id")
  raceDriverId         String     @map("race_driver_id")
  positionFinal        Int        @map("position_final")
  lapsCompleted        Int        @map("laps_completed")
  totalTimeRaw         String?    @map("total_time_raw")
  totalTimeSeconds     Float?     @map("total_time_seconds")
  fastLapTime          Float?     @map("fast_lap_time")
  avgLapTime           Float?     @map("avg_lap_time")
  consistency          Float?
  qualifyingPosition   Int?       @map("qualifying_position")
  secondsBehind        Float?     @map("seconds_behind")
  rawFieldsJson        Json?      @map("raw_fields_json")
  createdAt        DateTime   @default(now()) @map("created_at")
  updatedAt        DateTime   @updatedAt @map("updated_at")
  laps             Lap[]
  lapAnnotations   LapAnnotation[]
  raceDriver       RaceDriver @relation(fields: [raceDriverId], references: [id], onDelete: Cascade)
  race             Race       @relation(fields: [raceId], references: [id], onDelete: Cascade)

  @@unique([raceId, raceDriverId])
  @@index([raceId, raceDriverId])
  @@index([raceId])
  @@index([raceDriverId])
  @@index([positionFinal])
  @@map("race_results")
}

model Lap {
  id              String     @id @default(uuid())
  raceResultId    String     @map("race_result_id")
  lapNumber       Int        @map("lap_number")
  positionOnLap   Int        @map("position_on_lap")
  lapTimeRaw      String     @map("lap_time_raw")
  lapTimeSeconds  Float      @map("lap_time_seconds")
  paceString      String?    @map("pace_string")
  elapsedRaceTime Float      @map("elapsed_race_time")
  segmentsJson    Json?      @map("segments_json")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  raceResult      RaceResult @relation(fields: [raceResultId], references: [id], onDelete: Cascade)

  @@unique([raceResultId, lapNumber])
  @@index([raceResultId, lapNumber])
  @@index([raceResultId])
  @@index([lapNumber])
  @@map("laps")
}

model LapAnnotation {
  id              String     @id @default(uuid())
  raceResultId    String     @map("race_result_id")
  lapNumber       Int        @map("lap_number")
  invalidReason   String?    @map("invalid_reason")
  incidentType    String?    @map("incident_type")
  confidence      Float?     @map("confidence")
  metadata        Json?      @map("metadata")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")
  raceResult      RaceResult @relation(fields: [raceResultId], references: [id], onDelete: Cascade)

  @@unique([raceResultId, lapNumber])
  @@index([raceResultId, lapNumber])
  @@index([raceResultId])
  @@map("lap_annotations")
}

model TransponderOverride {
  id                  String   @id @default(uuid())
  eventId             String   @map("event_id")
  driverId            String   @map("driver_id")
  effectiveFromRaceId String?  @map("effective_from_race_id")
  transponderNumber   String   @map("transponder_number")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")
  createdBy           String?  @map("created_by")
  driver              Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  effectiveFromRace   Race?    @relation(fields: [effectiveFromRaceId], references: [id])
  event               Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, driverId, effectiveFromRaceId], map: "transponder_overrides_event_id_driver_id_effective_from_race_id")
  @@index([eventId, driverId])
  @@index([effectiveFromRaceId])
  @@map("transponder_overrides")
}

model UserDriverLink {
  id              String               @id @default(uuid())
  userId          String               @map("user_id")
  driverId        String               @unique @map("driver_id")
  status          UserDriverLinkStatus
  similarityScore Float                @map("similarity_score")
  matchedAt       DateTime             @map("matched_at")
  confirmedAt     DateTime?            @map("confirmed_at")
  rejectedAt      DateTime?            @map("rejected_at")
  matcherId       String               @map("matcher_id")
  matcherVersion  String               @map("matcher_version")
  conflictReason  String?              @map("conflict_reason")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  events          EventDriverLink[]
  driver          Driver               @relation(fields: [driverId], references: [id], onDelete: Cascade)
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, driverId])
  @@index([userId])
  @@index([driverId])
  @@index([status])
  @@map("user_driver_links")
}

model EventDriverLink {
  id                String                    @id @default(uuid())
  userId            String                    @map("user_id")
  eventId           String                    @map("event_id")
  driverId          String                    @map("driver_id")
  userDriverLinkId  String?                   @map("user_driver_link_id")
  matchType         EventDriverLinkMatchType  @map("match_type")
  similarityScore   Float                     @map("similarity_score")
  transponderNumber String?                   @map("transponder_number")
  matchedAt         DateTime                  @map("matched_at")
  status            EventDriverLinkStatus     @default(suggested) @map("status")
  confirmedAt       DateTime?                 @map("confirmed_at")
  rejectedAt        DateTime?                 @map("rejected_at")
  createdAt         DateTime                  @default(now()) @map("created_at")
  updatedAt         DateTime                  @updatedAt @map("updated_at")
  driver            Driver                    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  event             Event                     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userDriverLink    UserDriverLink?           @relation(fields: [userDriverLinkId], references: [id])
  user              User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId, driverId])
  @@index([userId, driverId, transponderNumber])
  @@index([eventId, driverId])
  @@index([userDriverLinkId])
  @@index([status])
  @@map("event_driver_links")
}

enum PersonaType {
  driver
  admin
  team_manager
  race_engineer
}

enum IngestDepth {
  none
  summary_only
  laps_full
}

enum UserDriverLinkStatus {
  suggested
  confirmed
  rejected
  conflict
}

enum EventDriverLinkMatchType {
  transponder
  exact
  fuzzy
}

enum EventDriverLinkStatus {
  suggested
  confirmed
  rejected
}

enum SessionType {
  race
  practice
  qualifying
  practiceday
}

model WeatherData {
  id               String   @id @default(uuid())
  eventId          String   @map("event_id")
  latitude         Float
  longitude        Float
  timestamp        DateTime
  airTemperature   Float    @map("air_temperature")
  humidity         Int
  windSpeed        Float    @map("wind_speed")
  windDirection    Int?     @map("wind_direction")
  precipitation    Int
  condition        String
  trackTemperature Float    @map("track_temperature")
  forecast         Json
  isHistorical     Boolean  @default(false) @map("is_historical")
  cachedAt         DateTime @default(now()) @map("cached_at")
  expiresAt        DateTime @map("expires_at")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  event            Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([expiresAt])
  @@index([eventId, expiresAt])
  @@map("weather_data")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String   @map("resource_type")
  resourceId   String?  @map("resource_id")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  createdAt    DateTime @default(now()) @map("created_at")
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([resourceType])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

model ApplicationLog {
  id        String   @id @default(uuid())
  level     String // debug, info, warn, error
  message   String
  service   String   @default("nextjs") // nextjs, ingestion, database
  context   Json?
  requestId String?  @map("request_id")
  userId    String?  @map("user_id")
  ip        String?
  path      String?
  method    String?
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([level])
  @@index([service])
  @@index([createdAt])
  @@index([level, service])
  @@index([service, createdAt])
  @@index([requestId])
  @@index([userId])
  @@map("application_logs")
}

model TrackMap {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  trackId     String   @map("track_id")
  name        String
  description String?
  mapData     Json     @map("map_data") // Array of shape objects
  isPublic    Boolean  @default(false) @map("is_public")
  shareToken    String?  @unique @map("share_token") // For shareable links
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  track       Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  
  @@index([userId, trackId])
  @@index([isPublic])
  @@index([shareToken])
  @@map("track_maps")
}
